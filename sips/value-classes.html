<!DOCTYPE html>
<html>
  <head>
    <title>SIP-15 - Value Classes | Scala Documentation</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/png" href="/resources/favicon.ico">
    <link rel="shortcut icon" type="image/png" href="/resources/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/resources/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/resources/favicon-16x16.png">
    <link rel="manifest" href="/resources/site.webmanifest">
    <link rel="mask-icon" href="/resources/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#15a9ce">
    <meta name="theme-color" content="#ffffff">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Custom stylesheet -->
    <link href="/resources/css/unslider-dots.css" rel="stylesheet" type="text/css">
    <link href="/resources/css/unslider.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/resources/css/highlightjs.css" type="text/css" />
    <link rel="stylesheet" href="/resources/css/style.css" type="text/css" />
    <link rel="stylesheet" href="/resources/css/monospace.css" type="text/css" />

    <!-- Atom feeds -->
    <link rel="alternate" type="application/atom+xml" title="News Feed" href="http://scala-lang.org/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Feed" href="http://scala-lang.org/feed/blog.xml" />

    <!-- Algolia stylesheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />


  </head>
  <body>


<div class="navigation-fade-screen"></div>

<header id="site-header">
  <div class="wrap">
    <nav class="navigation" role="menu">
      <a href="http://scala-lang.org" class="navigation-bdand">
        <img src="/resources/img/frontpage/scala-logo-white@2x.png" alt="">
      </a>
      <div class="navigation-panel-button">
        <i class="fa fa-bars"></i>
      </div>
      <ul class="navigation-menu">
        
            <li class="navigation-menu-item">
              <a href="/" class="active">Documentation</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/download/" >Download</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/community/" >Community</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://index.scala-lang.org" >Libraries</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/contribute/" >Contribute</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/blog/" >Blog</a>
            </li>
        
      </ul>
    </nav>
  </div>
</header>
<header id="doc-header">
  <div class="wrap" style="padding: 0px;">
    <nav class="doc-navigation" role="menu">
      <a href="/" class="navigation-bdand">
        <img src="/resources/img/documentation-logo@2x.png" alt="">
      </a>
      <div class="navigation-ellipsis">
        <i class="fa fa-ellipsis-v"></i>
      </div>
      <ul class="navigation-menu">
        
            <li class="navigation-menu-item">
              <a href="#" id="api" >API</a>
                
                <ul class="navigation-dropdown">
                
                  <li>
                    <a href="https://www.scala-lang.org/api/current/">Current</a>
                  </li>
                
                  <li>
                    <a href="https://www.scala-lang.org/files/archive/nightly/2.12.x/api/2.12.x/">Nightly</a>
                  </li>
                
                  <li>
                    <a href="/api/all.html">All Versions</a>
                  </li>
                
                </ul>
                
            </li>
        
            <li class="navigation-menu-item">
              <a href="#" id="learn" >Learn</a>
                
                <ul class="navigation-dropdown">
                
                  <li>
                    <a href="/getting-started.html">Getting Started</a>
                  </li>
                
                  <li>
                    <a href="/tour/tour-of-scala.html">Tour of Scala</a>
                  </li>
                
                  <li>
                    <a href="/tutorials/scala-for-java-programmers.html">Scala for Java Programmers</a>
                  </li>
                
                  <li>
                    <a href="/learn.html">Online Resources</a>
                  </li>
                
                </ul>
                
            </li>
        
            <li class="navigation-menu-item">
              <a href="#" id="reference" >Reference</a>
                
                <ul class="navigation-dropdown">
                
                  <li>
                    <a href="/overviews/index.html">Guides & Overviews</a>
                  </li>
                
                  <li>
                    <a href="/books.html">Books</a>
                  </li>
                
                  <li>
                    <a href="/tutorials/FAQ/index.html">Scala FAQs</a>
                  </li>
                
                  <li>
                    <a href="http://scala-lang.org/files/archive/spec/2.12/">Language Spec</a>
                  </li>
                
                </ul>
                
            </li>
        
            <li class="navigation-menu-item">
              <a href="/style/index.html" id="style guide" >Style Guide</a>
                
            </li>
        
            <li class="navigation-menu-item">
              <a href="/cheatsheets/index.html" id="cheatsheet" >Cheatsheet</a>
                
            </li>
        
            <li class="navigation-menu-item">
              <a href="/glossary/index.html" id="glossary" >Glossary</a>
                
            </li>
        
            <li class="navigation-menu-item">
              <a href="/sips/index.html" id="sips" >SIPs</a>
                
            </li>
        
      </ul>
    </nav>
    <nav class="doc-navigation-submenus">
      
        
          <ul class="navigation-submenu" id="api" style="display: none;">
            
              <li>
                <a href="https://www.scala-lang.org/api/current/">Current</a>
              </li>
            
              <li>
                <a href="https://www.scala-lang.org/files/archive/nightly/2.12.x/api/2.12.x/">Nightly</a>
              </li>
            
              <li>
                <a href="/api/all.html">All Versions</a>
              </li>
            
          </ul>
        
      
        
          <ul class="navigation-submenu" id="learn" style="display: none;">
            
              <li>
                <a href="/getting-started.html">Getting Started</a>
              </li>
            
              <li>
                <a href="/tour/tour-of-scala.html">Tour of Scala</a>
              </li>
            
              <li>
                <a href="/tutorials/scala-for-java-programmers.html">Scala for Java Programmers</a>
              </li>
            
              <li>
                <a href="/learn.html">Online Resources</a>
              </li>
            
          </ul>
        
      
        
          <ul class="navigation-submenu" id="reference" style="display: none;">
            
              <li>
                <a href="/overviews/index.html">Guides & Overviews</a>
              </li>
            
              <li>
                <a href="/books.html">Books</a>
              </li>
            
              <li>
                <a href="/tutorials/FAQ/index.html">Scala FAQs</a>
              </li>
            
              <li>
                <a href="http://scala-lang.org/files/archive/spec/2.12/">Language Spec</a>
              </li>
            
          </ul>
        
      
        
      
        
      
        
      
        
      
      <ul class="navigation-submenu ellipsis-menu" style="display: none;">
        
          
        
          
        
          
        
          
            <li><a href="/style/index.html">Style Guide</a></li>
          
        
          
            <li><a href="/cheatsheets/index.html">Cheatsheet</a></li>
          
        
          
            <li><a href="/glossary/index.html">Glossary</a></li>
          
        
          
            <li><a href="/sips/index.html">SIPs</a></li>
          
        
      </ul>
    </nav>
  </div>
</header>


<main id="inner-main">

  <!-- Title -->
  <section class="title-page">
    <div class="wrap">
      <div class="content-title-documentation">
        <div class="titles">
          
            <div class="supertitle">&nbsp;</div>
          
          <h1>SIP-15 - Value Classes</h1>
        </div>
        <div class="language-dropdown">
          <div id="dd" class="wrapper-dropdown" tabindex="1">
            <span>Language</span>
              <ul class="dropdown"></ul>
          </div>
      </div>
    </div>
  </section>

  
  <section class="content">
	<div class="wrap">
		<div class="content-primary documentation">
			<div class="inner-box toc-context">
				<p><strong>By: Martin Odersky and Jeff Olson and Paul Phillips and Joshua Suereth</strong></p>

<h2 id="history">History</h2>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Version</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Jan 30th 2012</td>
      <td>Original inline classes proposal</td>
    </tr>
    <tr>
      <td>Feb 7th 2012</td>
      <td>Changed inline classes to value classes, added Josh Suereth as author.</td>
    </tr>
  </tbody>
</table>

<h2 id="introduction">Introduction</h2>

<p>This is a proposal to introduce syntax for classes in Scala that can get
completely inlined, so operations on these classes have zero overhead compared
to external methods. Some use cases for inlined classes are:</p>

<ul>
  <li><em>Inlined implicit wrappers</em>. Methods on those wrappers would be translated to
extensions methods.</li>
  <li><em>New numeric classes</em>, such as unsigned ints. There would no longer need to be
a boxing overhead for such classes. So this is similar to value types in .NET.</li>
  <li>Classes representing <em>units of measure</em>. Again, no boxing overhead would be
incurred for these classes.</li>
</ul>

<p>The proposal is currently in an early stage. It’s not yet been implemented, and
the proposed implementation strategy is too complicated to be able to predict
with certainty that it will work as specified. Consequently, details of the
proposal might change driven by implementation concerns.</p>

<h2 id="value-classes">Value Classes</h2>

<p>The gist of the proposal is to allow user-defined classes to extend from AnyVal
in situations like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class C (val u: U) extends AnyVal {
  def m1(ps1) = ...
  ...
  def mN(psN) = ...
}
</code></pre></div></div>

<p>Such classes are called <em>value classes</em>. A value class <code class="highlighter-rouge">C</code> must satisfy the
following criteria:</p>

<ol>
  <li><code class="highlighter-rouge">C</code> must have exactly one parameter, which is marked with <code class="highlighter-rouge">val</code> and which has
public accessibility. The type of that parameter (e.g. <code class="highlighter-rouge">U</code> above) is called
the <em>underlying type</em> of <code class="highlighter-rouge">C</code></li>
  <li><code class="highlighter-rouge">C</code> may not have <code class="highlighter-rouge">@specialized</code> type parameters.</li>
  <li>The underlying type of <code class="highlighter-rouge">C</code> may not be a value class.</li>
  <li><code class="highlighter-rouge">C</code> may not have secondary constructors.</li>
  <li><code class="highlighter-rouge">C</code> may not define concrete <code class="highlighter-rouge">equals</code> or <code class="highlighter-rouge">hashCode</code> methods.</li>
  <li><code class="highlighter-rouge">C</code> must be either a toplevel class or a member of a statically accessible
object.</li>
  <li><code class="highlighter-rouge">C</code> must be ephemeral.</li>
</ol>

<p>A class or trait <code class="highlighter-rouge">C</code> is <em>ephemeral</em> if the following holds:</p>

<ol>
  <li><code class="highlighter-rouge">C</code> may not declare fields (other than the parameter of a value class).</li>
  <li><code class="highlighter-rouge">C</code> may not contain object definitions.</li>
  <li><code class="highlighter-rouge">C</code> may not have initialization statements.</li>
</ol>

<p>We say that a value class <code class="highlighter-rouge">C</code> <em>unboxes directly</em> to a class <code class="highlighter-rouge">D</code> if the
underlying type of <code class="highlighter-rouge">C</code> is a type-instance of <code class="highlighter-rouge">D</code>. Indirect unboxing is the
transitive closure of direct unboxing. A value class may not unbox directly or
indirectly to itself.</p>

<p>The following implicit assumptions apply to value classes.</p>

<ol>
  <li>Value classes are implicitly treated as final, so they cannot be extended by
other classes.</li>
  <li>
    <p>Value classes are implicitly assumed to have structural equality and hash codes. I.e.
their <code class="highlighter-rouge">equals</code> and <code class="highlighter-rouge">hashCode</code> methods are taken to be defined as follows:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> def equals(other: Any) = other match {
   case that: C =&gt; this.u == that.u
   case _ =&gt; false
 }
 def hashCode = u.hashCode
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="universal-traits">Universal traits</h2>

<p>Scala’s rule for inheritance do not permit value classes to extend traits that
extend from <code class="highlighter-rouge">AnyRef</code>. To permit value classes to extend traits, we introduce
<em>universal traits</em>, which extend from <code class="highlighter-rouge">Any</code>. A universal trait <code class="highlighter-rouge">T</code> needs to
explicitly extend class <code class="highlighter-rouge">Any</code>. In the example below, <code class="highlighter-rouge">Equals</code> is a universal
trait with superclass <code class="highlighter-rouge">Any</code>, but <code class="highlighter-rouge">Ordered</code>’s superclass is still assumed to be
<code class="highlighter-rouge">AnyRef</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trait Equals[T] extends Any { ... }
trait Ordered[T] extends Equal[T] { ... }
</code></pre></div></div>

<p>To turn <code class="highlighter-rouge">Ordered</code> into a universal trait, add an explicit superclass <code class="highlighter-rouge">Any</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trait Ordered[T] extends Any with Equal[T] { ... }
</code></pre></div></div>

<p>Like value classes, universal traits need to be ephemeral.</p>

<h2 id="expansion-of-value-classes">Expansion of value classes.</h2>

<p>Value classes are expanded as follows. For concreteness, we assume a value class
<code class="highlighter-rouge">Meter</code> that is defined like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Meter(val underlying: Double) extends AnyVal with Printable {
   def plus (other: Meter): Meter =
      new Meter(this.underlying + other.underlying)
   def divide (factor: Double): Meter = new Meter(this.underlying / factor)
   def less (other: Meter): Boolean = this.underlying &lt; other.underlying
   override def toString: String = underlying.toString + “m”
}
</code></pre></div></div>

<p>For simplicity we assume that all expansion steps are done on erased types.</p>

<h3 id="step-1-extracting-methods">Step 1: Extracting methods.</h3>

<p>Let the <em>extractable methods</em> of a value class be all methods that are directly
declared in the class (as opposed to being inherited) and that do not contain a
super call in their body. For each extractable method <code class="highlighter-rouge">m</code>, we create another
method named <code class="highlighter-rouge">extension$m</code> in the companion object of that class (if no
companion object exists, a fresh one is <em>created</em>). The <code class="highlighter-rouge">extension$m</code> method
takes an additional parameter in first position which is named <code class="highlighter-rouge">$this</code> and has
the value class as type. Generally, in a value class</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class C(val u: U) extends AnyVal
</code></pre></div></div>

<p>a method</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def m(params): R = body
</code></pre></div></div>

<p>is expanded to the following method in the companion object of class <code class="highlighter-rouge">C</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def extension$m($this: C, params): R = body2
</code></pre></div></div>

<p>Here <code class="highlighter-rouge">body2</code> is the same as <code class="highlighter-rouge">body</code> with each occurrence of <code class="highlighter-rouge">this</code> or <code class="highlighter-rouge">C.this</code>
replaced by <code class="highlighter-rouge">$this</code>. The original method <code class="highlighter-rouge">m</code> in <code class="highlighter-rouge">C</code> will be changed to</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def m(params): R = C.extension$m(this, params)
</code></pre></div></div>

<p>Overloaded methods may be augmented with an additional integer to distinguish
them after types are erased (see the transformations of the <code class="highlighter-rouge">divide</code> method in
the following steps).</p>

<p>Also in this step, synthetic <code class="highlighter-rouge">hashCode</code> and <code class="highlighter-rouge">equals</code> methods are added to the
class.</p>

<p>In our example, the <code class="highlighter-rouge">Meter</code> class would be expanded as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Meter(val underlying: Double) extends AnyVal with Printable {
    def plus (other: Meter): Meter =
       Meter.extension$plus(this, other)
    def divide (other: Meter): Double =
       Meter.extension1$divide(this, other)
    def divide (factor: Double): Meter =
       Meter.extension2$divide(this, factor)
    def less (other: Meter): Boolean =
       Meter.extension$less(this, other)
    override def toString: String =
       Meter.extension$toString(this)
    override def equals(other: Any) =
       Meter.extension$equals(this)
    override def hashCode =
       Meter.extension$hashCode(this)
}
object Meter {
   def extension$plus($this: Meter, other: Meter) =
     new Meter($this.underlying + other.underlying)
   def extension1$divide($this: Meter, other: Meter): Double =
     $this.underlying / other.underlying
   def extension2$divide($this: Meter, factor: Double): Meter =
     new Meter($this.underlying / factor)
   def extension$less($this: Meter, other: Meter): Boolean =
      $this.underlying &lt; other.underlying
   def extension$toString($this: Meter): String =
      $this.underlying.toString + “m”
   def extension$equals($this: Meter, other: Any) = other match {
      case that: Meter =&gt; $this.underlying == that.underlying
      case _ =&gt; false
   }
   def extension$hashCode($this: Meter) = $this.underlying
}
</code></pre></div></div>

<h3 id="step-2-rerouting-calls">Step 2: Rerouting calls</h3>

<p>In this step any call to a method that got extracted in step 1 into a companion
object gets redirected to the newly created method in that companion object.
Generally, a call</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p.m(args)
</code></pre></div></div>

<p>where <code class="highlighter-rouge">m</code> is an extractable method declared in a value class <code class="highlighter-rouge">C</code> gets rewritten to</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C.extension$m(p, args)
</code></pre></div></div>

<p>For instance the two calls in the following code fragment</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val x, y: Meter
x.plus(y)
x.toString
</code></pre></div></div>

<p>would be rewritten to</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Meter.extension$plus(x, y)
Meter.extension$toString(x)
</code></pre></div></div>

<h3 id="step-3-erasure">Step 3: Erasure</h3>

<p>Next, we introduce for each value class <code class="highlighter-rouge">C</code> a new type <code class="highlighter-rouge">C$unboxed</code> (this type
will be eliminated again in step 4). The newly generated type is assumed to have
no members and to be completely outside the normal Scala class hierarchy. That
is, it is a subtype of no other type and is a supertype only of <code class="highlighter-rouge">scala.Nothing</code>.</p>

<p>We now replace every occurrence of the type <code class="highlighter-rouge">C</code> in a symbol’s type or in a tree’s
type annotation by <code class="highlighter-rouge">C$unboxed</code>. There are however the following two exceptions
to this rule:</p>

<ol>
  <li>
    <p>Type tests are left unaffected. So, in the type test below, <code class="highlighter-rouge">C</code> is left as it
is.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> e.isInstanceOf[C]
</code></pre></div>    </div>
  </li>
  <li>
    <p>All occurrences of methods in class <code class="highlighter-rouge">C</code> are left unaffected.</p>
  </li>
</ol>

<p>We then re-typecheck the program, performing the following adaptations if types
do not match up.</p>

<ol>
  <li>
    <p>If <code class="highlighter-rouge">e</code> is an expression of type <code class="highlighter-rouge">C$unboxed</code>, and the expected type is some other
type <code class="highlighter-rouge">T</code>, <code class="highlighter-rouge">e</code> is converted to type <code class="highlighter-rouge">C</code> using</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> new C(e.asInstanceOf[U])
</code></pre></div>    </div>

    <p>where <code class="highlighter-rouge">U</code> is the underlying type of <code class="highlighter-rouge">C</code>. After that, further adaptations may
be effected on <code class="highlighter-rouge">C</code>, employing the usual rules of erasure typing. Similarly,
if a selection is performed on an expression of type <code class="highlighter-rouge">C$unboxed</code>, the
expression is first converted to type <code class="highlighter-rouge">C</code> using the conversion above.</p>
  </li>
  <li>
    <p>If the expected type of an expression <code class="highlighter-rouge">e</code> of type <code class="highlighter-rouge">T</code> is <code class="highlighter-rouge">C$unboxed</code>, then
<code class="highlighter-rouge">e</code> is first adapted with expected type <code class="highlighter-rouge">C</code> giving <code class="highlighter-rouge">e2</code>, and <code class="highlighter-rouge">e2</code> then is
converted to <code class="highlighter-rouge">C$unboxed</code> using</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> e2.u.asInstanceOf[C$unboxed]
</code></pre></div>    </div>

    <p>where <code class="highlighter-rouge">u</code> is the name of the value parameter of <code class="highlighter-rouge">C</code>. Similarly, if an
expression <code class="highlighter-rouge">e</code> is explicitly converted using</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> e.asInstanceOf[C$unboxed]
</code></pre></div>    </div>

    <p>then <code class="highlighter-rouge">e</code> is first converted to type <code class="highlighter-rouge">C</code>, giving <code class="highlighter-rouge">e2</code>, and the cast is then
replaced by</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> e2.u.asInstanceOf[C$unboxed]
</code></pre></div>    </div>
  </li>
  <li>
    <p>The rules for conversions from and to arrays over value classes are analogous
to the rules for arrays over primitive value classes.</p>
  </li>
</ol>

<p>Value classes are rewritten at this stage to normal reference classes. That is,
their parent changes from <code class="highlighter-rouge">AnyVal</code> to <code class="highlighter-rouge">java.lang.Object</code>. The <code class="highlighter-rouge">AnyVal</code> type
itself is also rewritten during erasure to <code class="highlighter-rouge">java.lang.Object</code>, so the change
breaks no subtype relationships.</p>

<p>We finally perform the following peephole optimizations:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new C(e).u               ==&gt; e
new C(e).isInstanceOf[C] ==&gt; true
new C(e) == new C(f)     ==&gt; e == f
new C(e) != new C(f)     ==&gt; e != f
</code></pre></div></div>

<h3 id="step-4-cleanup">Step 4: Cleanup</h3>

<p>In the last step, all occurrences of type <code class="highlighter-rouge">C$unboxed</code> are replaced by the
underlying type of <code class="highlighter-rouge">C</code>. Any redundant casts of the form</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>e.asInstanceOf[T]
</code></pre></div></div>

<p>where <code class="highlighter-rouge">e</code> is already of type <code class="highlighter-rouge">T</code> are removed and replaced by <code class="highlighter-rouge">e</code>.</p>

<h2 id="examples">Examples</h2>

<h3 id="example-1">Example 1</h3>

<p>The program statements on the left are converted using steps 1 to 3 to the
statements on the right.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var m, n: Meter           var m, n: Meter$unboxed
var o: AnyRef             var o: AnyRef
m = n                     m = n
o = m                     o = new Meter(m.asInstanceOf[Double])
m.print                   new Meter(m.asInstanceOf[Double]).print
m less n                  Meter.extension$less(m, n)
m.toString                Meter.extension$toString(m)
m.isInstanceOf[Ordered]   new Meter(m.asInstanceOf[Double]).isInstanceOf[Ordered]
m.asInstanceOf[Ordered]   new Meter(m.asInstanceOf[Double]).asInstanceOf[Ordered]
o.isInstanceOf[Meter]     o.isInstanceOf[Meter]
o.asInstanceOf[Meter]     o.asInstanceOf[Meter].underlying.asInstanceOf[Meter$unboxed]
m.isInstanceOf[Meter]     new Meter(m.asInstanceOf[Double]).isInstanceOf[Meter]
m.asInstanceOf[Meter]     m.asInstanceOf[Meter$unboxed]
</code></pre></div></div>

<p>Including the cleanup step 4 the same program statements are converted as
follows.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var m, n: Meter           var m, n: Double
var o: Any                var o: Any
m = n                     m = n
o = m                     o = new Meter(m)
m.print                   new Meter(m).print
m less n                  Meter.extension$less(m, n)
m.toString                Meter.extension$toString(m)
m.isInstanceOf[Ordered]   new Meter(m).isInstanceOf[Ordered]
m.asInstanceOf[Ordered]   new Meter(m).asInstanceOf[Ordered]
o.isInstanceOf[Meter]     o.isInstanceOf[Meter]
o.asInstanceOf[Meter]     o.asInstanceOf[Meter].underlying
m.isInstanceOf[Meter]     new Meter(m).isInstanceOf[Meter]
m.asInstanceOf[Meter]     m.asInstanceOf[Double]
</code></pre></div></div>

<h3 id="example-2">Example 2</h3>

<p>After all 4 steps the <code class="highlighter-rouge">Meter</code> class is translated to the following code.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Meter(val underlying: Double) extends AnyVal with Printable {
   def plus (other: Meter): Meter =
     new Meter(Meter.extension$plus(this.underlying, other.underlying))
   def divide (other: Meter): Double =
     Meter.extension1$divide(this.underlying, other)
   def divide (factor: Double): Meter =
     new Meter(Meter.extension2$divide(this.underlying, factor))
   def less (other: Meter): Boolean =
     Meter.extension$less(this.underlying, other)
   override def toString: String =
     Meter.extension$toString(this.underlying)
   override def equals(other: Any) =
     Meter.extension$equals(this)
   override def hashCode =
     Meter.extension$hashCode(this)
}
object Meter {
  def extension$plus($this: Double, other: Double) =
    $this + other
  def extension1$divide($this: Double, other: Double): Double =
    $this / other
  def extension2$divide($this: Double, factor: Double): Double =
    $this / factor)
  def extension$less($this: Double, other: Double): Boolean =
    $this &lt; other
  def extension$toString($this: Double): String =
    $this.toString + “m”
  def extension$equals($this: Double, other: Object) = other match {
    case that: Meter =&gt; $this == that.underlying
    case _ =&gt; false
  }
  def extension$hashCode($this: Double) = $this.hashCode
}
</code></pre></div></div>

<p>Note that the two <code class="highlighter-rouge">divide</code> methods end up with the same type in object <code class="highlighter-rouge">Meter</code>.
(The fact that they also have the same body is accidental). That’s why we needed
to distinguish them by adding an integer number.</p>

<p>The same situation can arise in other circumstances as well: Two overloaded
methods might end up with the same type after erasure. In the general case,
Scala would treat this situation as an error, as it would for other types that
get erased. So we propose to solve only the specific problem that multiple
overloaded methods in a value class itself might clash after erasure.</p>

<h2 id="further-optimizations">Further Optimizations?</h2>

<p>The proposal foresees that only methods defined directly in a value class get
expanded in the companion object; methods inherited from universal traits are
unaffected. For instance, in the example above</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>m.print
</code></pre></div></div>

<p>would translate to</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new Meter(m).print
</code></pre></div></div>

<p>We might at some point want to investigate ways how inherited trait methods can
also be inlined. For the moment this is outside the scope of the proposal.</p>

			</div>
		</div>

		<!-- TOC -->
    <div class="content-nav">
    	<div class="inner-box sidebar-toc-wrapper sip-toc" style="">
      
        <h5 class="contents">SIP Committee Decision</h5>
         <div class="tag" style="background-color: #859900">Complete</div>
           <p class="vote-text" style="color: #859900">
             This SIP has already been accepted and completed. There has been concern for numerical computing.  We think future SIP(s), using work from SIP-15, can provide more benefit to numerical computing users. The SIP as it exists benefits all users of implicit enrichment classes, and takes us much further to unboxed high performance code. This SIP does not exclude further work towards improving numerical computing in Scala.
           </p>
        
    		<h5 class="contents">SIP Contents</h5>
    		<div class="inner-toc" id="sidebar-toc">
          <div id="toc"></div>
    		</div>
    		<hr>
    		<div class="help-us"><a href="https://github.com/scala/docs.scala-lang/blob/master/_sips/sips/2012-01-30-value-classes.md"><i class="fa fa-pencil" aria-hidden="true"></i> Problem with this page?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Please help us fix it!</a></div>
    	</div>
    </div>

	</div>
</section>


</main>

<footer id="site-footer">
    <div class="wrap">
      <div class="site-footer-top">
        
          <ul class="documentation">
            <li><h3>Documentation</h3></li>
            
              <li><a href="/getting-started.html">Getting Started</a></li>
            
              <li><a href="https://www.scala-lang.org/api/current/index.html">API</a></li>
            
              <li><a href="/overviews">Overviews/Guides</a></li>
            
              <li><a href="http://scala-lang.org/files/archive/spec/2.12/">Language Specification</a></li>
            
          </ul>
        
          <ul class="download">
            <li><h3>Download</h3></li>
            
              <li><a href="http://scala-lang.org/download/">Current Version</a></li>
            
              <li><a href="http://scala-lang.org/download/all.html">All versions</a></li>
            
          </ul>
        
          <ul class="community">
            <li><h3>Community</h3></li>
            
              <li><a href="http://scala-lang.org/community/">Community</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#mailing-lists">Mailing Lists</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#chat-rooms">Chat Rooms & More</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#community-libraries-and-tools">Libraries and Tools</a></li>
            
              <li><a href="http://scala.epfl.ch/">The Scala Center</a></li>
            
          </ul>
        
          <ul class="contribute">
            <li><h3>Contribute</h3></li>
            
              <li><a href="http://scala-lang.org/contribute/">How to help</a></li>
            
              <li><a href="http://scala-lang.org/contribute/bug-reporting-guide.html">Report an Issue</a></li>
            
          </ul>
        
          <ul class="scala">
            <li><h3>Scala</h3></li>
            
              <li><a href="http://scala-lang.org/blog/">Blog</a></li>
            
              <li><a href="http://scala-lang.org/conduct/">Code of Conduct</a></li>
            
              <li><a href="http://scala-lang.org/license/">License</a></li>
            
          </ul>
        
          <ul class="social">
            <li><h3>Social</h3></li>
            
              <li><a href="https://github.com/scala/scala">GitHub</a></li>
            
              <li><a href="https://twitter.com/scala_lang">Twitter</a></li>
            
          </ul>
        
      </div>
      <div class="site-footer-bottom">
        <p></p>
        <img src="/resources/img/frontpage/scala-logo-white.png" alt="">
      </div>
    </div>
    <a class="back-to-top in" href="#" id="scroll-to-top-btn">
      <i class="fa fa-angle-up"></i>
    </a>
</footer>

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
<script>(window.jQuery) || document.write('<script src="/scripts/jquery-3.1.1.min.js"><\/script>');</script>
<script src="/resources/js/vendor/jquery.autocomplete.js" type="text/javascript"></script>

<!-- moment js -->
<script src="/resources/js/vendor/moment.min.js" type="text/javascript"></script>

<!-- tweet feed -->
<script src="/resources/js/tweetMachine-update.js" type="text/javascript"></script>

<!-- prettify js -->
<script src="/resources/js/vendor/prettify/prettify.js" type="text/javascript"></script>
<script src="/resources/js/vendor/prettify/lang-scala.js" type="text/javascript"></script>

<!-- unslider js -->
<script src="/resources/js/vendor/unslider.js" type="text/javascript"></script>

<!-- Highlight -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/scala.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/java.min.js" type="text/javascript"></script>

<!-- CodeMirror -->
<script src="/resources/js/vendor/codemirror/codemirror.js" type="text/javascript"></script>
<script src="/resources/js/vendor/codemirror/clike.js" type="text/javascript"></script>

<!-- TOC -->
<script src="/resources/js/vendor/jquery.sticky.js" type="text/javascript"></script>
<script src="/resources/js/vendor/toc.js" type="text/javascript"></script>

<!-- Blog search -->
<script src="/resources/js/vendor/jekyll.search.min.js" type="text/javascript"></script>

<!-- Custom javascript -->
<script src="/resources/js/functions.js" type="text/javascript"></script>



<!-- Alogolia search for doc -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: 'fbc439670f5d4e3730cdcb715c359391',
indexName: 'scala-lang',
inputSelector: '#doc-search-bar',
algoliaOptions: { 'facetFilters': ["language:en"] },
debug: false // Set debug to true if you want to inspect the dropdown
});
</script>
</body>

</html>

